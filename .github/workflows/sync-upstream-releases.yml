name: Sync Upstream Releases

on:
  schedule:
    # Check for new upstream releases daily at 9 AM UTC (9 AM GMT / 10 AM BST)
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Specific upstream release tag to sync (e.g., v0.28.7)'
        required: false
        type: string

jobs:
  check-releases:
    runs-on: ubuntu-latest
    outputs:
      new-release: ${{ steps.check.outputs.new-release }}
      latest-tag: ${{ steps.check.outputs.latest-tag }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Add upstream remote and fetch
      run: |
        git remote add upstream https://github.com/zephyrproject-rtos/docker-image.git || true
        git fetch upstream --tags
    
    - name: Check for new releases
      id: check
      run: |
        # Get latest upstream release tag
        LATEST_UPSTREAM=$(git ls-remote --tags --refs upstream | grep -o 'refs/tags/v[0-9]*\.[0-9]*\.[0-9]*$' | sort -V | tail -1 | sed 's|refs/tags/||')
        
        # Get latest tag in our fork
        LATEST_LOCAL=$(git tag | grep '^v[0-9]*\.[0-9]*\.[0-9]*$' | sort -V | tail -1 || echo "v0.0.0")
        
        echo "Latest upstream: $LATEST_UPSTREAM"
        echo "Latest local: $LATEST_LOCAL"
        
        echo "latest-tag=$LATEST_UPSTREAM" >> $GITHUB_OUTPUT
        
        if [ "$LATEST_UPSTREAM" != "$LATEST_LOCAL" ]; then
          echo "new-release=true" >> $GITHUB_OUTPUT
          echo "üÜï New upstream release detected: $LATEST_UPSTREAM"
        else
          echo "new-release=false" >> $GITHUB_OUTPUT
          echo "‚úÖ Already up to date with $LATEST_LOCAL"
        fi

  sync-release:
    runs-on: ubuntu-latest
    needs: check-releases
    if: needs.check-releases.outputs.new-release == 'true' || github.event.inputs.release_tag != ''
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Add upstream remote and fetch
      run: |
        git remote add upstream https://github.com/zephyrproject-rtos/docker-image.git || true
        git fetch upstream --tags
    
    - name: Determine target release
      id: target
      run: |
        if [ -n "${{ github.event.inputs.release_tag }}" ]; then
          TAG="${{ github.event.inputs.release_tag }}"
        else
          TAG="${{ needs.check-releases.outputs.latest-tag }}"
        fi
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "Syncing with upstream release: $TAG"
    
    - name: Create sync branch
      run: |
        BRANCH="sync-upstream-${{ steps.target.outputs.tag }}"
        git checkout -b $BRANCH
        echo "branch=$BRANCH" >> $GITHUB_ENV
    
    - name: Merge upstream release
      run: |
        git merge ${{ steps.target.outputs.tag }} --no-edit -m "Merge upstream release ${{ steps.target.outputs.tag }}" || {
          echo "‚ùå Merge conflict detected!"
          echo "You'll need to manually resolve conflicts in the PR"
          git merge --abort
          exit 1
        }
    
    - name: Push sync branch
      run: |
        git push origin ${{ env.branch }}
    
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ env.branch }}
        title: "Sync with upstream release ${{ steps.target.outputs.tag }}"
        body: |
          üîÑ This PR syncs the fork with upstream release **${{ steps.target.outputs.tag }}**
          
          ## Release Notes
          See: https://github.com/zephyrproject-rtos/docker-image/releases/tag/${{ steps.target.outputs.tag }}
          
          ## Changes
          - Merges upstream release ${{ steps.target.outputs.tag }}
          - Preserves custom CI modifications
          
          ## Review Checklist
          - [ ] Review upstream changes
          - [ ] Verify custom CI still works
          - [ ] Test Docker builds locally
          - [ ] Check ZSDK_TOOLCHAINS configuration
          
          ---
          *Automatically created by sync-upstream-releases workflow*
        labels: |
          upstream-sync
          automated-pr
